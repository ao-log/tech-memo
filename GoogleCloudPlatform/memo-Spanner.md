
# 特徴

### 特性

MySQL のようなリレーショナル DB と同じ特性を持つ。

* スキーマ
* 強整合性
* SQL クエリ

にも関わらず、分散 DB の特性を持つ。

* HA (高可用性）
* 水平方向のスケーラビリティ（動的にダウンタイムなしにノードの追加・削除が可能）

### その他特徴

* オートインクリメントは無し

# 設計時のポイント

* ホットスポットの発生を防止するためシーケンシャルな PK を使わないこと。UUID がおすすめ。
* 親子関係のあるレコードはインタリーブを使う。

# アーキテクチャ

### クライアント

クライアントライブラリがあるので、それを使って gRPC もしくは REST API で Spanner に読み書きする。

### ノード

クライアントからの要求を受けつけて、Spanner への読み書き処理を実行するコンピューティングリソース。1 ノードで 2 TiB まで扱える。

##### シングルリージョンで利用する場合

* ノード 1 台を起動すると、各ゾーンにそのレプリカが立ち上がる。
* あるゾーンのレプリカがダウンすると、他のゾーンのレプリカがリーダーに選択される。
* ゾーン間のレプリケーションは Paxos プロトコルに基づいて行われる。

##### マルチリージョンで利用する場合

* US のみが ReadWrite リージョンとなる。他のリージョンは ReadOnly リージョンとなる。
* RO レプリカは約 15 秒ごとに RW レプリカと同期する。

### ストレージ

Colossus という Google が開発した分散ファイルシステム。
GFS の後任。[中井さんの記事が分かりやすい。](https://www.school.ctc-g.co.jp/columns/nakai2/nakai203.html)

### split

Cloud Spanner でのデータの単位。

テーブルを Split に分割している。Split ごとに管理するノードが決まっていて、そのノード経由でアクセスされる。シャードは Split のオーナとなるノードを変えるだけなので高速。

一つの Split には数千行のレコードが格納されており、容量上限は 4GB。

### インタリーブ

テーブルの親子関係のこと。インタリーブにすることで、関連するデータを同じ Split に格納することができる。同じノードからアクセスできるので、レイテンシ面で有利となる。

# レプリカ

### 読み書きレプリカの特徴

* データの完全なコピーを維持。
* 読み取りを処理。
* 書き込みを commit するかどうかを投票できる。
* リーダーの選出に参加できる。
* リーダーになる資格がある。
* 単一リージョン インスタンスで使用できる唯一のタイプ。

### 読み取りレプリカの特徴

* マルチリージョン インスタンスでのみ使用される。
* データの完全なコピーを維持します。このデータは読み書きレプリカから複製れる。
* 読み取りを処理。
* 書き込みの commit を決める投票に参加しない。したがって、読み取り専用レプリカのロケーションは書き込みのレイテンシに影響しない。
* デフォルトのリーダーリージョンへのラウンドトリップが必要のないステイル読み取りを処理。ステイルネスは 15 秒以上と想定されている。強力な読み取りを行う場合には、リーダーレプリカへのラウンド トリップが必要な場合がある。
* リーダーになることはできない。

### ウィットネス

* マルチリージョン インスタンスでのみ使用される。
* データの完全なコピーは維持しない。
* 読み取りを処理しない。
* 書き込みの commit を決める投票に参加。
* リーダーの選出に参加するが、リーダーになる資格はない。

### 書き込み処理

* クライアントの書き込みリクエストは、最初にリーダーレプリカに送信される。
* リーダーレプリカは受信した書き込みを記録し、この書き込みへの投票資格がある他のレプリカに同時に転送する。投票資格のあるレプリカは、書き込みを完了した後、書き込みを commit するかどうかの投票結果をリーダーに返す。投票レプリカ（書き込みクォーラム）の過半数が書き込みの commit に同意すると、書き込みが commit される
* バックグラウンドでは、ウィットネスを除く残りのすべてのレプリカが書き込みを記録する。

### 読み取り

* リーダーレプリカがシリアル化に必要なロックを保持しているため、読み書きトランザクションに含まれる読み取りはリーダーレプリカから処理される。
* 読み取りの同時実行モードによっては、単一の読み取りメソッド（トランザクションのコンテキスト外の読み取り）と読み取り専用トランザクションの読み取りでリーダーとの通信が必要になる場合がある。
* 強力な読み取りリクエストは、任意の読み書きレプリカまたは読み取り専用レプリカに送信される。リクエストがリーダー以外のレプリカに送信された場合、このレプリカはリーダーと通信を行い、読み取りを実行する必要がある。
* ステイル読み取りリクエストは、リクエストのタイムスタンプに従って最も近い読み取り専用レプリカまたは読み書きレプリカに送信される。なお、最も近いレプリカがリーダーレプリカの場合、リーダーレプリカに送信される。

# 参考

[Cloud Spanner](https://cloud.google.com/spanner/)

[レプリケーション](https://cloud.google.com/spanner/docs/replication)

[超実践 Cloud Spanner 設計講座](https://www.slideshare.net/HammoudiSamir/cloud-spanner-78081604)

[Cloud Spanner のハイレベルアーキテクチャ解説](https://medium.com/google-cloud-jp/cloud-spanner-%E3%81%AE%E3%83%8F%E3%82%A4%E3%83%AC%E3%83%99%E3%83%AB%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3%E8%A7%A3%E8%AA%AC-fee62c17f7ed)
