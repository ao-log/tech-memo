
## バケットとオブジェクト

* バケット名はグローバルで一意である必要がある。
* オブジェクトはバケット内にフラットに配置される。「/」でフォルダ構造を表現することが可能。
* 「xxxx/yyyyyy」を例にすると、「xxxx/yyyyyy」がキー名。「yyyyyy」がオブジェクト名。

## 結果一貫性

* 新規登録時には、即時に読み取り可能。
* 更新、削除時には古いデータを読み取ることがある。
* 更新時にロックはしない。最新のタイムスタンプのものを採用。
* 一覧時にも古い情報で読み取ることがある。

## ストレージクラス

| ストレージクラス | 説明 |
|---|---|
| STANDARD | 複数の AZ にデータを配置。 |
| STANDARD-IA | STANDARD より格納が安価。読み出し容量に対しても課金。 |
| INTELLIGENT_TIERING | アクセス頻度に応じて自動的に最適化。 |
| ONEZONE_IA | Single AZ にデータを配置。ただし、複数 DC (?) でコピーをもつ。AZ が丸ごと壊れた場合は、データロストの可能性大。 |
| S3 Glacier | 低コスト。読み出しに時間とコストがかかる。 |
| 低冗長化ストレージ (RRS) | 耐久性が低い。Glacier から取り出したデータの置き場所。 |

ライフサイクルを設定可能。

## S3 へのアクセス方法

* AWS SDK
* AWS CLI
* Management Console

## アクセス権限

デフォルトではバケット、オブジェクトへは作成した AWS アカウントのみでアクセス可能。バケット、オブジェクト単位で、権限を設定可能。

| 項目 | 説明 |
|---|---|
| ユーザポリシー | IAM ユーザにアクセス権を設定。 |
| バケットポリシー | バケットごとにアクセス権を設定。IAM ユーザ、クロスアカウント、IP アドレス、HTTP Referrer、CloudFront、MFA 制限なども可能。 |
| ACL | IAM よりも前の時代のアクセス制御の名残。現在ではログ出力時などに設定する。ACLより、ユーザポリシー、バケットポリシーが推奨される。 |

#### 同じアカウントのアクセス権限の考え方

* IAM ポリシーで許可されていれば、バケットポリシーで許可されていなくてもアクセス可能
* IAM ポリシーで許可していない場合でも、バケットポリシーで IAM ユーザの ARN を Principal で許可すればアクセス可能。

[S3のバケットポリシーでハマったので、S3へのアクセスを許可するPrincipalの設定を整理する](https://dev.classmethod.jp/cloud/aws/summarize-principal-settings-in-s3-bucket-policy/)


AWS Config でパブリックアクセスになっているかどうかをチェックするマネージドルールが提供されている。

**Amazon S3 Block Public Access** でアカウント、バケットレベルであらかじめ意図せずパブリックになるのを防止できる。

## VPC Endpoint

Private Subnet から VPC Endpoint を経由することで、インターネットに出ずに S3 にアクセス可能。ただし、同一リージョン内のみ。アクセスポリシーを設定可能。

## 署名付き URL

AWS SDK or CLI を利用して生成された URL に対して指定期間のアクセスを許可。

## Web ホスティング

静的な Web サイトを S3 でホスティング可能。
リダイレクト機能で、任意のドメインにリダイレクト可能。

CloudFront と連携可能。また、バケットポリシーで CloudFront からのみ許可することも可能。

## その他機能

| 機能 | 説明 |
|---|---|
| 暗号化 | サーバサイド暗号化、クライアントサイド暗号化を選べる。 |
| バージョニング | 同じキー名(ファイル名)でアップロードすると前のバージョンが残る。 |
| S3 Object Lock | バケット単位、オブジェクト単位で削除不可な期間を指定できる。コンプライアンスモードだと root ですら削除不可。 |
| クロスリージョンレプリケーション | 別リージョンにレプリケーションを実施。データ転送費用は発生する。 |
| S3 Analytics | どのストレージクラスにいつ移動すれば良いかを分析するサービス。1〜2 日程度要する。Quick Sight で可視化可能。 |
| S3 インベントリ | オブジェクトのリストを csv, orc ファイルで取得する。 |
| S3 バッチオペレーション | 大量のオブジェクトに対する API アクションを一括実行。 |
| S3 イベント通知 | バケットのイベント発生時、SNS, SQS, Lambda と連携できる機能。 |
| 操作ログ | CloudTrail を有効にすることで S3 への操作ログを収集可能。保存先は別の S3 バケットを推奨。 |
| Logging | バケット単位で、アクセスログを出力可能。 |
| Tag | バケット、オブジェクトに対して Tag 指定が可能。 |
| S3 select | オブジェクトの一部のみを抽出。CSV, JSON が対象。Athena の方が柔軟らしい |

## パフォーマンス最適化

* ダウンロード時: RANGE GET、アップロード時: マルチパートアップロード
* S3 Transfer Acceleration: AWS のエッジネットワーク経由で高速な S3 とのデータ転送を実現。
* データ追加、取得量に応じて自動でスケール。
* 近年はキー名でパフォーマンス改善する必要性はなくなったらしい。

## 料金

容量とリクエストに課金される。そのため、容量は小さいけれど大量のファイルがある場合は注意。

# 参考

* [[AWS Black Belt Online Seminar] Amazon S3/Glacier 資料及び QA 公開](https://aws.amazon.com/jp/blogs/news/webinar-bb-amazon-s3-glacier-2019/)
* [S3 ドキュメント](https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/dev/Welcome.html)
