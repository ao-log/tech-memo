GCPUG Tokyo Kubernetes Engine Day April 2018 のメモです。  
https://gcpug-tokyo.connpass.com/event/81224/

---

## microservice on GKEEEE at mercari by deeeet

メルカリ社の方の発表。スライド枚数 200 枚と怒涛の内容だったが、分かりやすく説明してくださった。

GCP のノウハウを載せている GitHub リポジトリがある。ノウハウを持っている人はプルリクを送って欲しいとのこと。  
https://github.com/gcpug/nouhau

##### microservice 化に向かう理由

モノリスは厳しい。変更時の影響範囲、密結合で複雑な依存関係など。
そこでマイクロサービスである。

##### メルカリで採用しているアーキテクチャ

クライアントからの要求は API Gateway で受ける。JSON でのやりとりだとバリデーションなどが面倒だが、protobuf を使うとバリデーションを考慮する必要がなくなり楽になる。

もともとモノリスだったサービスと API Gateway の間にプロキシを挟む。はじめは転送するだけにして、徐々にプロキシにサービスを移していくことで、マイクロサービス化していく（Strangler Pattern と呼ぶらしい）。API Gateway、サービス間のプロトコルは gRPC。

GPC のロードバランサはバッファリングされないため、golang でスクラッチで書いたロードバランサで対応している。

##### デプロイ

CircleCI でコンテナビルドし、レジストリにアップロードし、それを承認したらデプロイするフロー。Spinnaker を採用している。

[参考]  
http://tech.mercari.com/entry/2017/08/21/092743

##### コンテナデプロイの健全性

Kayenta がある。カナリアリリースをし、その時のリソース使用状況などのメトリクスをモニタリングして、そのデプロイが異常か健全かを点数付をする。N 点以上であれば OK、未満であればロールバックというように判定に活用できる。

[参考]  
http://www.publickey1.jp/blog/18/googlenetflixkayenta.html

##### サービスメッシュ

サービス間の通信を統一的な仕組みで制御。セキュリティ確保に使える？　サービス間の通信は Envoy が行う。よって、コード側を変える必要が無くなる。

[参考]  
http://www.atmarkit.co.jp/ait/articles/1802/09/news015.html  
https://istio.io/

##### 開発、運用

1 クラスタに載せている。
サービスごとにネームスペースを作り、1 つの GPU PJ を作成している。サービスアカウントでアクセス。
PJ の作成は、GitHub でプルリクすると CI が走り、Terarform で作成している。

イギリスでは、プリエンプティブインスタンスを使用し、天然のカオス・モンキーのようなことをやっている。

[参考]  
http://tech.mercari.com/entry/2018/04/09/110000

##### ログ

ログは Stack Driver から sink 機能を利用して、BigQuery に流している。

### k8s

##### Heptio Ark

k8s の内容を Cloud Storage 上にバックアップしてくれる

##### CircleCI

Container Builder を使わず、CircleCI を使っている。プルリクや notification に使いたいので。

##### Gremlin

カオスを起こすことが出来る。


## GKE パネルディスカッション

##### 開発者とインフラ担当者の担当範囲

開発者が Dockerfile まで見るパターンが多かった。小規模な PJ だと開発者がもっと幅広く見る場合も。

##### k8s 上でデータベースを動かすか

マネージドサービス派が多め。裏に DB があって、コンテナ上はメモリキャッシュ系という構成ならありえる。

##### 監視

DataDog 派が多め。最近、コンテナマップが使えるようになった。

##### セキュリティ

IAM で SRE だけがログイン出来るようにしている。開発者は kubectl を実行できないようにしている。

コンテナイメージに脆弱性がある場合がある。コンテナレジストリに脆弱性のチェック機能がある。試したら、いっぱい深刻な脆弱性が見つかりびっくりした。メルカリさんは appine + golang。コンテナビルド時にインストールするパッケージも不要なので、本番用のコンテナにはバイナリだけを置く。マルチステージでビルドし、イメージを最小化する。

[参考]  
https://speakerdeck.com/ianlewis/kubernetesfalsesekiyuriteifalsebesutopurakuteisu  
https://alpinelinux.org/  
https://docs.docker.com/develop/develop-images/dockerfile_best-practices/

##### ロードバランサ

Ingress の HTTP LB を使っている。ヘルスチェックはハマる人が多いらしく、README を読まないと分からないらしい。

##### オートスケール

スケールアウトは GCE の起動を考えると 1 分はかかる。時間がわかっている場合は暖気しておいたほうがいい。スパイクがあってスケールアウトしたあと、スケールインに時間がかかり、なかなか数が減らない。

##### リリース情報をどこまで追っているか

欲しい機能があるときは、リリースを待っていることもある。

GCP のブログ(英語版の方だけ？)で月一ペースでサマライズした記事が出る。

##### バージョンアップ

なるべく追随している。ただ、リリース後すぐにではなく、少し様子を見たい感じはする。バージョンアップを先延ばしにして一気に上げるのが厳しい状況は避けたい。

##### デプロイ

Blue/Green は料金が 2 倍必要。規模が大きいものだと、ローリングアップデートにすることがある。

ローリングアップデートはバージョンが全体で揃わない。よって避けて、Blue/Green で対応するチームもある。
